<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>لعبة عيد الهالوين باستخدام WebXR وThree.js</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
    </style>
</head>
<body>
    <!-- استخدام type="module" لتحميل ملفات ES6 Modules -->
    <script type="module">
        // استيراد مكتبة Three.js و VRButton من CDN
        import * as THREE from 'https://unpkg.com/three@0.148.0/build/three.module.js';
        import { VRButton } from 'https://unpkg.com/three@0.148.0/examples/jsm/webxr/VRButton.js';

        // إنشاء المشهد
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000); // خلفية سوداء لإضفاء جو مظلم

        // إعداد الكاميرا
        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;

        // إعداد المُحرك
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        // إضافة زر الدخول إلى VR
        document.body.appendChild(VRButton.createButton(renderer));

        // إضافة إضاءة
        const ambientLight = new THREE.AmbientLight(0x404040, 2); // إضاءة خفيفة
        scene.add(ambientLight);

        const pointLight = new THREE.PointLight(0xffffff, 1);
        pointLight.position.set(5, 10, 7.5);
        scene.add(pointLight);

        // تحميل خريطة قشرة اليقطين
        const textureLoader = new THREE.TextureLoader();
        const pumpkinTexture = textureLoader.load(
            'https://threejsfundamentals.org/threejs/resources/images/flower-1.jpg', // استبدلها بخريطة يقطين حقيقية إن وجدت
            () => { renderer.render(scene, camera); }, // onLoad
            undefined, // onProgress
            (err) => { console.error('فشل تحميل الخامة', err); } // onError
        );

        // إنشاء مادة اليقطين
        const pumpkinMaterial = new THREE.MeshStandardMaterial({ 
            map: pumpkinTexture,
            side: THREE.DoubleSide 
        });

        // إنشاء مجموعة من اليقطين
        const pumpkins = [];
        const pumpkinGeometry = new THREE.SphereGeometry(0.5, 32, 32);

        for (let i = 0; i < 10; i++) {
            const pumpkin = new THREE.Mesh(pumpkinGeometry, pumpkinMaterial);
            pumpkin.position.set(
                (Math.random() - 0.5) * 10,
                (Math.random() - 0.5) * 5,
                -Math.random() * 10
            );
            scene.add(pumpkin);
            pumpkins.push(pumpkin);
        }

        // إعداد Raycaster للكشف عن النقرات
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        function onClick(event) {
            // الحصول على موقع الماوس بالنسبة للشاشة
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;

            // تحديث Raycaster
            raycaster.setFromCamera(mouse, camera);

            // تحديد العناصر المتقاطعة
            const intersects = raycaster.intersectObjects(pumpkins);

            if (intersects.length > 0) {
                const clickedPumpkin = intersects[0].object;
                scene.remove(clickedPumpkin);
                const index = pumpkins.indexOf(clickedPumpkin);
                if (index > -1) {
                    pumpkins.splice(index, 1);
                }
            }
        }

        window.addEventListener('click', onClick, false);

        // التعامل مع تغيير حجم النافذة
        window.addEventListener('resize', onWindowResize, false);

        function onWindowResize(){
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // دالة التحديث والرندر
        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render() {
            // دوران خفيف لليقطين لإضفاء حياة
            pumpkins.forEach(pumpkin => {
                pumpkin.rotation.y += 0.005;
            });

            renderer.render(scene, camera);
        }

        animate();
    </script>
</body>
</html>
